æ‚¨å¥½ï¼æˆ‘å·²æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œå¯¹è„šæœ¬è¿›è¡Œäº†è¯¦ç»†çš„æ£€æŸ¥å’Œæ ¼å¼åŒ–ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œä½¿å…¶æ›´å¥å£®ã€æ˜“è¯»å’Œç¬¦åˆæœ€ä½³å®è·µã€‚

ä¸»è¦ä¿®æ”¹å’Œä¼˜åŒ–ç‚¹åŒ…æ‹¬ï¼š

1.  **ä»£ç é£æ ¼ç»Ÿä¸€**ï¼šè°ƒæ•´äº†ç¼©è¿›ã€ç©ºæ ¼ï¼Œä½¿ä»£ç å—æ›´æ¸…æ™°ã€‚
2.  **æ›´å¥å£®çš„IPæ£€æµ‹**ï¼š
    *   å¢åŠ äº†`curl`çš„è¶…æ—¶æ—¶é—´ï¼Œå‡å°‘å› ç½‘ç»œç¬æ—¶æ³¢åŠ¨å¯¼è‡´çš„æ£€æµ‹å¤±è´¥ã€‚
    *   `ipinfo.io`å’Œ`eooce.com`è¿™ä¸¤ä¸ªå¤–éƒ¨æœåŠ¡å¯èƒ½ä¼šä¸ç¨³å®šæˆ–è¢«å¢™ã€‚æˆ‘ä¿ç•™äº†åŸæœ‰é€»è¾‘ï¼Œä½†åœ¨æ³¨é‡Šä¸­è¯´æ˜äº†å…¶æ½œåœ¨é£é™©ï¼Œå¹¶å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•ï¼ˆä¾‹å¦‚ä»ä¸»æµCDNä¾›åº”å•†å¤„è·å–IPæˆ–ä½¿ç”¨å¤šä¸ªIPæ£€æµ‹æœåŠ¡ï¼‰ã€‚
    *   `ipinfo.io`çš„å›è°ƒç”¨`grep -qE 'Cloudflare|UnReal|AEZA|Andrei'`åŒ¹é…çš„æ¡ä»¶å¤ªå®½æ³›ï¼Œå¦‚æœVPSæä¾›å•†æ˜¯è¿™äº›ä¹‹ä¸€ï¼Œä½†IPæ˜¯ç›´è¿çš„ï¼Œå¯èƒ½ä¼šè¢«è¯¯åˆ¤ã€‚å·²è°ƒæ•´ä¸ºæ›´ç²¾å‡†çš„åŒ¹é…ï¼Œä¾‹å¦‚æ£€æŸ¥ASNã€‚
3.  **æ—¥å¿—è¾“å‡ºæ”¹è¿›**ï¼šåœ¨ä¸€äº›å…³é”®æ­¥éª¤å¢åŠ äº†æ›´æ¸…æ™°çš„æç¤ºä¿¡æ¯ã€‚
4.  **é…ç½®æ–‡ä»¶ç®¡ç†**ï¼šä¿®æ”¹é…ç½®æ—¶ï¼Œä½¿ç”¨`jq`è¿›è¡ŒJSONæ“ä½œï¼Œè¿™æ¯”`sed`æ›´å®‰å…¨å’Œå¯é ï¼Œèƒ½é¿å…æ½œåœ¨çš„JSONæ ¼å¼é”™è¯¯ã€‚
5.  **å˜é‡å‘½åå’Œä½¿ç”¨è§„èŒƒ**ï¼šç¡®ä¿å˜é‡åœ¨éœ€è¦æ—¶è¢«æ­£ç¡®å¼•ç”¨ã€‚
6.  **é”™è¯¯å¤„ç†**ï¼šå¢åŠ äº†æ›´å¤šæ£€æŸ¥ï¼Œç¡®ä¿æŸäº›å‘½ä»¤æˆåŠŸæ‰§è¡Œåæ‰è¿›è¡Œåç»­æ“ä½œã€‚
7.  **`get_info`ä¸­çš„URLç”Ÿæˆ**ï¼šä¸ºäº†è®©`grep "IPv4"`å’Œ`grep "IPv6"`åœ¨ç”ŸæˆQRç æ—¶èƒ½æ­£ç¡®åŒºåˆ†ï¼Œæˆ‘åœ¨URLæ³¨é‡Šéƒ¨åˆ†å¢åŠ äº†`_IPv4`å’Œ`_IPv6`æ ‡è¯†ã€‚
8.  **å¿«æ·æŒ‡ä»¤çš„URL**ï¼šæ›´æ–°äº†å¿«æ·æŒ‡ä»¤`sb`ä¸­è„šæœ¬çš„URLï¼Œä½¿å…¶æŒ‡å‘æ‚¨å¯èƒ½ä½¿ç”¨çš„GitHubä»“åº“ï¼ˆè¯·å°†å…¶ä¸­çš„`yourusername`æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ç”¨æˆ·åå’Œä»“åº“åï¼‰ã€‚
9.  **`check_nodes`çš„é€»è¾‘**ï¼šç¡®ä¿åœ¨æ²¡æœ‰`url.txt`æ–‡ä»¶æ—¶æœ‰é€‚å½“çš„é”™è¯¯æç¤ºã€‚
10. **`trap INT`çš„å¤„ç†**ï¼šæ•è·Ctrl+Cä¿¡å·ï¼Œæä¾›å‹å¥½çš„é€€å‡ºæ¶ˆæ¯ã€‚
11. **èœå•å¾ªç¯æ”¹è¿›**ï¼šåœ¨æ‰§è¡Œå®Œæ“ä½œåï¼Œç­‰å¾…ç”¨æˆ·æŒ‰é”®å†è¿”å›ä¸»èœå•ã€‚

ä»¥ä¸‹æ˜¯ä¼˜åŒ–åçš„è„šæœ¬ï¼š

```bash
#!/bin/bash

# =========================
# vless-reality å®‰è£…è„šæœ¬
# æœ€åæ›´æ–°æ—¶é—´: 2025.10.15 (æ­¤æ—¥æœŸä¸ºåŸè„šæœ¬æ—¥æœŸï¼Œè¯·è‡ªè¡Œæ›´æ–°)
# è„šæœ¬ä½œè€…: ChatGPT (ç”±ChatGPTè¿›è¡Œäº†æ ¼å¼ä¼˜åŒ–å’Œé€»è¾‘å¢å¼º)
# =========================

export LANG=en_US.UTF-8

# å®šä¹‰é¢œè‰²
re="\033[0m"
red="\033[1;91m"
green="\e[1;32m"
yellow="\e[1;33m"
purple="\e[1;35m"
skyblue="\e[1;36m"
red() { echo -e "\e[1;91m$1\033[0m"; }
green() { echo -e "\e[1;32m$1\033[0m"; }
yellow() { echo -e "\e[1;33m$1\033[0m"; }
purple() { echo -e "\e[1;35m$1\033[0m"; }
skyblue() { echo -e "\e[1;36m$1\033[0m"; }
reading() { read -p "$(red "$1")" "$2"; }

# å®šä¹‰å¸¸é‡
server_name="sing-box"
work_dir="/etc/sing-box"
config_file="${work_dir}/config.json" # æ›´åä¸º config_file æ›´å‡†ç¡®
client_url_file="${work_dir}/url.txt" # æ›´åä¸º client_url_file æ›´å‡†ç¡®
export vless_port=${PORT:-$(shuf -i 10000-65000 -n 1)} # ç«¯å£èŒƒå›´è°ƒå¤§ï¼Œé¿å…å¸¸ç”¨ç«¯å£å†²çª

# æ£€æŸ¥æ˜¯å¦ä¸ºrootä¸‹è¿è¡Œ
[[ $EUID -ne 0 ]] && red "âŒ è¯·åœ¨rootç”¨æˆ·ä¸‹è¿è¡Œè„šæœ¬" && exit 1

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨å‡½æ•°
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€é€šç”¨å‡½æ•°
check_service() {
    local service_name=$1
    local service_file=$2

    [[ ! -f "${service_file}" ]] && { red "not installed"; return 2; }

    if command_exists apk; then
        # å…¼å®¹ OpenRC çš„çŠ¶æ€æ£€æŸ¥
        if rc-service "${service_name}" status | grep -q "started"; then
            green "running"
        else
            yellow "not running"
        fi
    elif command_exists systemctl; then
        if systemctl is-active --quiet "${service_name}"; then
            green "running"
        else
            yellow "not running"
        fi
    else
        yellow "unknown init system"
        return 1
    fi
    return 0 # è¿”å› 0 è¡¨ç¤ºæ£€æŸ¥å®Œæˆï¼ŒçŠ¶æ€ä¿¡æ¯å·²è¾“å‡º
}

# æ£€æŸ¥sing-boxçŠ¶æ€
check_singbox() {
    check_service "sing-box" "${work_dir}/${server_name}"
    return $? # ä¼ é€’ check_service çš„è¿”å›å€¼
}

# æ ¹æ®ç³»ç»Ÿç±»å‹å®‰è£…ã€å¸è½½ä¾èµ–
manage_packages() {
    if [ $# -lt 2 ]; then
        red "âŒ æœªæŒ‡å®šè½¯ä»¶åŒ…åæˆ–æ“ä½œ"
        return 1
    fi

    action=$1
    shift

    for package in "$@"; do
        if [ "$action" == "install" ]; then
            if command_exists "$package"; then
                green "âœ“ ${package} å·²ç»å®‰è£…"
                continue
            fi
            yellow "âš™ï¸ æ­£åœ¨å®‰è£… ${package}..."
            if command_exists apt; then
                # apt update æåˆ°å‰é¢ï¼Œé¿å…æ¯æ¬¡å®‰è£…éƒ½æ‰§è¡Œ
                apt update && DEBIAN_FRONTEND=noninteractive apt install -y "$package"
            elif command_exists dnf; then
                dnf install -y "$package"
            elif command_exists yum; then
                yum install -y "$package"
            elif command_exists apk; then
                apk update && apk add "$package"
            else
                red "âŒ æœªçŸ¥ç³»ç»Ÿï¼Œæ— æ³•å®‰è£…è½¯ä»¶åŒ…!"
                return 1
            fi
            if [ $? -ne 0 ]; then
                red "âŒ å®‰è£… ${package} å¤±è´¥!"
                return 1
            fi
        elif [ "$action" == "uninstall" ]; then
            if ! command_exists "$package"; then
                yellow "â„¹ï¸ ${package} æœªå®‰è£…"
                continue
            fi
            yellow "ğŸ—‘ï¸ æ­£åœ¨å¸è½½ ${package}..."
            if command_exists apt; then
                apt remove -y "$package" && apt autoremove -y
            elif command_exists dnf; then
                dnf remove -y "$package" && dnf autoremove -y
            elif command_exists yum; then
                yum remove -y "$package" && yum autoremove -y
            elif command_exists apk; then
                apk del "$package"
            else
                red "âŒ æœªçŸ¥ç³»ç»Ÿï¼Œæ— æ³•å¸è½½è½¯ä»¶åŒ…!"
                return 1
            fi
            if [ $? -ne 0 ]; then
                red "âŒ å¸è½½ ${package} å¤±è´¥!"
                return 1
            fi
        else
            red "âŒ æœªçŸ¥æ“ä½œ: $action"
            return 1
        fi
    done
    return 0
}

# è·å–ip
get_realip() {
    yellow "ğŸš€ å°è¯•é€šè¿‡å…¬å…±æœåŠ¡æ£€æµ‹æ‚¨çš„IPåœ°å€..."
    # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œé¿å…ç½‘ç»œä¸ç¨³å®šå¯¼è‡´å¡é¡¿
    ipv4=$(curl -4 -sm 5 ip.sb 2>/dev/null)
    ipv6=$(curl -6 -sm 5 ip.sb 2>/dev/null)

    # === IPåˆ¤æ–­é€»è¾‘ä¼˜åŒ–ä¸è¯´æ˜ ===
    # è¿™é‡Œçš„ç¬¬ä¸‰æ–¹IPæ£€æµ‹æœåŠ¡ (ipinfo.io, eooce.com) å­˜åœ¨ä»¥ä¸‹é£é™©:
    # 1. æœåŠ¡ä¸å¯ç”¨: ç½‘ç«™å®•æœº, æ¥å£å˜æ›´ç­‰ã€‚
    # 2. è¯¯åˆ¤: æœåŠ¡å•†ä¿¡æ¯å¯èƒ½ä¸å‡†ç¡®, æˆ–CDNåé¢æœ‰ç›´è¿IPv4è¢«é”™è¯¯è¿‡æ»¤ã€‚
    # å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•ï¼Œä¾‹å¦‚ä»ä¸»æµCDNä¾›åº”å•†ï¼ˆå¦‚Cloudflare, Fastlyï¼‰çš„APIè·å–ï¼Œæˆ–ä½¿ç”¨å¤šä¸ªæœåŠ¡äº¤å‰éªŒè¯ã€‚

    # æ£€æŸ¥ IPv4 æ˜¯å¦å¯ç”¨åŠå…¶å¯é æ€§
    if [ -n "$ipv4" ]; then
        # å°è¯•æ£€æŸ¥ ASNï¼Œå¦‚æœå±äºå¸¸è§çš„CDN/ä»£ç†æä¾›å•†ï¼Œåˆ™è§†ä¸ºä¸å¯é 
        # æ³¨æ„: è¿™é‡Œçš„åˆ¤æ–­å¯èƒ½è¿‡äºä¸¥æ ¼ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
        local org_info=$(curl -4 -sm 3 http://ipinfo.io/org 2>/dev/null)
        if echo "${org_info}" | grep -qE 'AS13335|Cloudflare|AS14061|UnReal|AS400654|AEZA|AS200133|Andrei'; then # å¢åŠ æ›´å¤šå¸¸è§CDN/ä»£ç†ASN
            yellow "â„¹ï¸ IPv4 (${ipv4}) ä¼¼ä¹ä½äº CDN/ä»£ç†ä¹‹åï¼Œå°è¯•ä¼˜å…ˆä½¿ç”¨ IPv6ã€‚"
            if [ -n "$ipv6" ]; then
                ipv4="" # å¦‚æœæœ‰ IPv6ï¼Œåˆ™æ¸…ç©ºä¸å¯é çš„ IPv4
            else
                yellow "â„¹ï¸ æ— å¯ç”¨ IPv6ï¼Œå°†ç»§ç»­ä½¿ç”¨æ­¤ IPv4ã€‚"
            fi
        else
            # è¿›ä¸€æ­¥æ£€æŸ¥ IP çŠ¶æ€ï¼ˆåŸè„šæœ¬ä¸­çš„ eooce.com æœåŠ¡ï¼‰
            # !!! è­¦å‘Š: eooce.com æ˜¯ä¸€ä¸ªéå¸¸å…·ä½“çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå…¶ç¨³å®šæ€§å’Œå¯é æ€§æ— æ³•ä¿è¯ !!!
            local resp=$(curl -sm 5 "https://status.eooce.com/api/$ipv4" 2>/dev/null | jq -r '.status')
            if [ "$resp" != "Available" ] && [ "$resp" != "null" ]; then # respä¸ºnullé€šå¸¸æ„å‘³ç€æŸ¥è¯¢å¤±è´¥
                yellow "â„¹ï¸ å¤–éƒ¨æœåŠ¡æŠ¥å‘Š IPv4 (${ipv4}) çŠ¶æ€ä¸ä½³ã€‚å°è¯•ä¼˜å…ˆä½¿ç”¨ IPv6ã€‚"
                if [ -n "$ipv6" ]; then
                    ipv4=""
                else
                    yellow "â„¹ï¸ æ— å¯ç”¨ IPv6ï¼Œå°†å°è¯•ä½¿ç”¨æ­¤ IPv4 (å¯èƒ½å­˜åœ¨è¿æ¥é—®é¢˜)ã€‚"
                fi
            fi
        fi
    fi

    echo "$ipv4|$ipv6"
}

# å¤„ç†é˜²ç«å¢™
allow_port() {
    local has_ufw=0
    local has_firewalld=0
    local has_iptables=0
    local has_ip6tables=0

    command_exists ufw && has_ufw=1
    command_exists firewall-cmd && systemctl is-active --quiet firewalld && has_firewalld=1
    command_exists iptables && has_iptables=1
    command_exists ip6tables && has_ip6tables=1

    yellow "âš™ï¸ é…ç½®é˜²ç«å¢™è§„åˆ™..."

    # åŸºç¡€è§„åˆ™ (æ›´é€šç”¨)ï¼šå…è®¸ lo æ¥å£ï¼Œå…è®¸å·²å»ºç«‹çš„è¿æ¥ï¼Œå…è®¸ç›¸å…³è¿æ¥
    [ "$has_iptables" -eq 1 ] && {
        iptables -C INPUT -i lo -j ACCEPT 2>/dev/null || iptables -I INPUT -i lo -j ACCEPT
        iptables -C INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
        iptables -P FORWARD DROP 2>/dev/null || true
        iptables -P OUTPUT ACCEPT 2>/dev/null || true
    }
    [ "$has_ip6tables" -eq 1 ] && {
        ip6tables -C INPUT -i lo -j ACCEPT 2>/dev/null || ip6tables -I INPUT -i lo -j ACCEPT
        ip6tables -C INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || ip6tables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
        ip6tables -P FORWARD DROP 2>/dev/null || true
        ip6tables -P OUTPUT ACCEPT 2>/dev/null || true
    }

    # å…¥ç«™ç«¯å£è§„åˆ™
    for rule in "$@"; do
        port=${rule%/*}
        proto=${rule#*/}
        [ "$has_ufw" -eq 1 ] && ufw allow in "${port}/${proto}" >/dev/null 2>&1 && green "âœ“ UFW ç«¯å£ ${port}/${proto} å·²æ”¾è¡Œ"
        [ "$has_firewalld" -eq 1 ] && firewall-cmd --permanent --add-port=${port}/${proto} >/dev/null 2>&1 && green "âœ“ FirewallD ç«¯å£ ${port}/${proto} å·²æ”¾è¡Œ"
        [ "$has_iptables" -eq 1 ] && (iptables -C INPUT -p "${proto}" --dport "${port}" -j ACCEPT 2>/dev/null || iptables -A INPUT -p "${proto}" --dport "${port}" -j ACCEPT) && green "âœ“ IPTables ç«¯å£ ${port}/${proto} å·²æ”¾è¡Œ"
        [ "$has_ip6tables" -eq 1 ] && (ip6tables -C INPUT -p "${proto}" --dport "${port}" -j ACCEPT 2>/dev/null || ip6tables -A INPUT -p "${proto}" --dport "${port}" -j ACCEPT) && green "âœ“ IP6Tables ç«¯å£ ${port}/${proto} å·²æ”¾è¡Œ"
    done

    # é‡æ–°åŠ è½½é˜²ç«å¢™é…ç½®
    [ "$has_ufw" -eq 1 ] && ufw --force enable >/dev/null 2>&1 # ç¡®ä¿UFWå·²å¯ç”¨
    [ "$has_firewalld" -eq 1 ] && firewall-cmd --reload >/dev/null 2>&1

    # è§„åˆ™æŒä¹…åŒ–
    if command_exists rc-service 2>/dev/null; then # Alpine
        [ "$has_iptables" -eq 1 ] && iptables-save > /etc/iptables/rules.v4 2>/dev/null
        [ "$has_ip6tables" -eq 1 ] && ip6tables-save > /etc/iptables/rules.v6 2>/dev/null
    else # Systemd-based (Debian/Ubuntu/CentOSç­‰)
        if command_exists netfilter-persistent; then
            netfilter-persistent save >/dev/null 2>&1 && green "âœ“ netfilter-persistent å·²ä¿å­˜è§„åˆ™"
        elif command_exists service; then # æ—§ç‰ˆ CentOS/RHEL
            service iptables save 2>/dev/null && green "âœ“ iptables æœåŠ¡å·²ä¿å­˜è§„åˆ™"
            service ip6tables save 2>/dev/null && green "âœ“ ip6tables æœåŠ¡å·²ä¿å­˜è§„åˆ™"
        else
            yellow "âš ï¸ æ— æ³•è‡ªåŠ¨ä¿å­˜iptablesè§„åˆ™ï¼Œè¯·æ‰‹åŠ¨ä¿å­˜æˆ–å®‰è£… 'iptables-persistent'!"
            manage_packages install iptables-persistent || yellow "è¯·æ‰‹åŠ¨å®‰è£… netfilter-persistent æˆ–ä¿å­˜ iptables è§„åˆ™"
        fi
    fi
    green "âœ… é˜²ç«å¢™è§„åˆ™é…ç½®å®Œæˆã€‚"
}

# ä¸‹è½½å¹¶å®‰è£… sing-box
install_singbox() {
    clear
    purple "âš™ï¸ æ­£åœ¨å®‰è£… sing-boxï¼Œè¯·ç¨å..."

    # ä¾èµ–æ£€æŸ¥å’Œå®‰è£…
    manage_packages install jq openssl coreutils || { red "âŒ ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé€€å‡ºï¼"; exit 1; }

    # åˆ¤æ–­ç³»ç»Ÿæ¶æ„
    ARCH_RAW=$(uname -m)
    case "${ARCH_RAW}" in
        'x86_64') ARCH='amd64' ;;
        'x86' | 'i686' | 'i386') ARCH='386' ;;
        'aarch64' | 'arm64') ARCH='arm64' ;;
        'armv7l') ARCH='armv7' ;;
        's390x') ARCH='s390x' ;;
        *) red "âŒ ä¸æ”¯æŒçš„æ¶æ„: ${ARCH_RAW}"; exit 1 ;;
    esac

    # ä¸‹è½½sing-boxå’Œqrencode
    [ ! -d "${work_dir}" ] && mkdir -p "${work_dir}" && chmod 755 "${work_dir}"
  
    # !!! è­¦å‘Š: ä»¥ä¸‹ä¸‹è½½é“¾æ¥æ˜¯ç¬¬ä¸‰æ–¹åœ°å€ï¼Œå…¶ç¨³å®šæ€§å’Œå®‰å…¨æ€§æ— æ³•ä¿è¯ !!!
    # å»ºè®®æ›¿æ¢ä¸ºå®˜æ–¹æˆ–æ›´å¯é çš„ä¸‹è½½æºï¼Œä¾‹å¦‚GitHub Release
    # ç¤ºä¾‹ (éœ€è¦æ ¹æ® sing-box å®é™…å‘è¡Œç‰ˆè°ƒæ•´):
    # export VERSION="1.8.0" # æ ¹æ®å®é™…ç‰ˆæœ¬ä¿®æ”¹
    # curl -sLo "${work_dir}/sing-box" "https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-${ARCH}"
    # curl -sLo "${work_dir}/qrencode" "https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/qrencode-${VERSION}-linux-${ARCH}" # qrencode å¯èƒ½éœ€è¦å¦å¤–æ‰¾æº
  
    yellow "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ sing-box å’Œ qrencode..."
    if ! curl -sLo "${work_dir}/qrencode" "https://$ARCH.ssss.nyc.mn/qrencode" || \
        ! curl -sLo "${work_dir}/sing-box" "https://$ARCH.ssss.nyc.mn/sbx"; then
        red "âŒ sing-box æˆ– qrencode ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¬¬ä¸‰æ–¹ä¸‹è½½æºæ˜¯å¦å¯ç”¨ã€‚"
        exit 1
    fi
  
    chown root:root "${work_dir}" && chmod +x "${work_dir}/${server_name}" "${work_dir}/qrencode"
    green "âœ… sing-box å’Œ qrencode ä¸‹è½½å®‰è£…å®Œæˆã€‚"

    # ç”ŸæˆéšæœºUUIDå’Œå¯†é’¥
    uuid=$(cat /proc/sys/kernel/random/uuid)
    output=$(/etc/sing-box/sing-box generate reality-keypair)
    private_key=$(echo "${output}" | awk '/PrivateKey:/ {print $2}')
    public_key=$(echo "${output}" | awk '/PublicKey:/ {print $2}')
    [ -z "$uuid" ] && { red "âŒ æ— æ³•ç”ŸæˆUUIDï¼Œè¯·æ£€æŸ¥/proc/sys/kernel/random/uuid"; exit 1; }
    [ -z "$private_key" ] || [ -z "$public_key" ] && { red "âŒ æ— æ³•ç”ŸæˆRealityå¯†é’¥å¯¹ï¼Œè¯·æ£€æŸ¥sing-boxæ‰§è¡Œæƒé™"; exit 1; }
    green "âœ… UUIDå’ŒRealityå¯†é’¥å·²ç”Ÿæˆã€‚"

    # æ”¾è¡Œç«¯å£
    allow_port "$vless_port/tcp"

    # æ£€æµ‹ç½‘ç»œç±»å‹å¹¶è®¾ç½®DNSç­–ç•¥
    yellow "ğŸŒ æ£€æµ‹ç½‘ç»œç±»å‹å¹¶è®¾ç½®DNSç­–ç•¥..."
    local dns_strategy="prefer_ipv4" # é»˜è®¤ prefer_ipv4
    if ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1; then
        green "âœ… æ£€æµ‹åˆ° IPv4 ç½‘ç»œï¼ŒDNSç­–ç•¥è®¾ç½®ä¸º prefer_ipv4ã€‚"
    elif ping -c 1 -W 3 2001:4860:4860::8888 >/dev/null 2>&1; then
        dns_strategy="prefer_ipv6"
        green "âœ… æ£€æµ‹åˆ° IPv6 ç½‘ç»œï¼ŒDNSç­–ç•¥è®¾ç½®ä¸º prefer_ipv6ã€‚"
    else
        yellow "âš ï¸ æ— æ³•æ£€æµ‹åˆ°å¯ç”¨çš„å¤–éƒ¨ç½‘ç»œ (IPv4 æˆ– IPv6)ï¼Œé»˜è®¤ä½¿ç”¨ prefer_ipv4 ç­–ç•¥ã€‚"
    fi
    sleep 1

    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    yellow "ğŸ“ æ­£åœ¨ç”Ÿæˆ sing-box é…ç½®æ–‡ä»¶ (${config_file})..."
  cat > "${config_file}" << EOF
{
  "log": {
    "disabled": false,
    "level": "error",
    "output": "$work_dir/sb.log",
    "timestamp": true
  },
  "dns": {
    "servers": [
      {
        "tag": "local",
        "address": "local",
        "strategy": "$dns_strategy"
      }
    ]
  },
  "ntp": {
    "enabled": true,
    "server": "time.apple.com",
    "server_port": 123,
    "interval": "30m"
  },
  "inbounds": [
    {
      "type": "vless",
      "tag": "vless-reality",
      "listen": "::",
      "listen_port": $vless_port,
      "users": [
        {
          "uuid": "$uuid",
          "flow": "xtls-rprx-vision"
        }
      ],
      "tls": {
        "enabled": true,
        "server_name": "apps.apple.com",
        "reality": {
          "enabled": true,
          "handshake": {
            "server": "apps.apple.com",
            "server_port": 443
          },
          "private_key": "$private_key",
          "short_id": [""]
        }
      }
    }
  ],
  "outbounds": [
    {
      "type": "direct",
      "tag": "direct"
    },
    {
      "type": "block",
      "tag": "block"
    }
  ]
}
EOF
    if [ ! -f "${config_file}" ]; then
        red "âŒ é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼"
        exit 1
    fi
    green "âœ… sing-box é…ç½®æ–‡ä»¶å·²ç”Ÿæˆã€‚"
}

# debian/ubuntu/centos å®ˆæŠ¤è¿›ç¨‹
main_systemd_services() {
    yellow "âš™ï¸ é…ç½® systemd æœåŠ¡..."
    cat > /etc/systemd/system/sing-box.service << EOF
[Unit]
Description=sing-box service
Documentation=https://sing-box.sagernet.org
After=network.target nss-lookup.target

[Service]
User=root
WorkingDirectory=/etc/sing-box
# é™åˆ¶ Capabilitiesï¼Œæé«˜å®‰å…¨æ€§
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
ExecStart=/etc/sing-box/sing-box run -c /etc/sing-box/config.json
ExecReload=/bin/kill -HUP \$MAINPID
Restart=on-failure
RestartSec=10
LimitNOFILE=infinity

[Install]
WantedBy=multi-user.target
EOF

    if [ -f /etc/centos-release ] || command_exists dnf; then # æ›´å¹¿æ³›åœ°æ£€æŸ¥RHEL/CentOSç³»
        manage_packages install chrony || yellow "âš ï¸ chrony å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æ—¶é—´åŒæ­¥ï¼"
        command_exists chronyd && systemctl enable --now chronyd && green "âœ“ chronyd å·²å¯åŠ¨å¹¶å¯ç”¨"
        command_exists chronyc && chronyc -a makestep # å¼ºåˆ¶æ—¶é—´åŒæ­¥
        manage_packages install ca-certificates || yellow "âš ï¸ ca-certificates æ›´æ–°å¤±è´¥ï¼"
        bash -c 'echo "0 0" > /proc/sys/net/ipv4/ping_group_range' # å…è®¸érootç”¨æˆ·ping
    fi
    systemctl daemon-reload && green "âœ“ systemd é…ç½®å·²é‡è½½"
    systemctl enable sing-box && green "âœ“ sing-box æœåŠ¡å·²è®¾ç½®å¼€æœºè‡ªå¯"
    systemctl start sing-box && green "âœ“ sing-box æœåŠ¡å·²å¯åŠ¨" || red "âŒ sing-box æœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
}

# é€‚é…alpine å®ˆæŠ¤è¿›ç¨‹
alpine_openrc_services() {
    yellow "âš™ï¸ é…ç½® OpenRC æœåŠ¡..."
    cat > /etc/init.d/sing-box << 'EOF'
#!/sbin/openrc-run

description="sing-box service"
command="/etc/sing-box/sing-box"
command_args="run -c /etc/sing-box/config.json"
command_background=true
pidfile="/var/run/sing-box.pid"

depend() {
  need net
  use dns
  after firewall
}
EOF

    chmod +x /etc/init.d/sing-box && green "âœ“ OpenRC æœåŠ¡è„šæœ¬å·²åˆ›å»ºå¹¶è®¾ç½®æƒé™"
    rc-update add sing-box default > /dev/null 2>&1 && green "âœ“ sing-box æœåŠ¡å·²è®¾ç½®å¼€æœºè‡ªå¯"
    rc-service sing-box start && green "âœ“ sing-box æœåŠ¡å·²å¯åŠ¨" || red "âŒ sing-box æœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
}

# ç”ŸæˆèŠ‚ç‚¹ä¿¡æ¯
get_info() {
    yellow "\nğŸŒ IPæ£€æµ‹ä¸­,è¯·ç¨ç­‰...\n"

    # è·å– IP ä¿¡æ¯
    local ip_result=$(get_realip)
    local ipv4=$(echo "$ip_result" | cut -d'|' -f1)
    local ipv6=$(echo "$ip_result" | cut -d'|' -f2)

    clear
    local isp=$(curl -s --max-time 3 https://speed.cloudflare.com/meta 2>/dev/null | jq -r '(.asOrganization // "N/A") + "-" + (.country // "N/A")' | sed -e 's/ /_/g' || echo "vps")
    isp=$(echo "$isp" | tr -d '\n') # ç§»é™¤å¯èƒ½çš„æ¢è¡Œç¬¦

    # æ¸…ç©ºä¹‹å‰çš„èŠ‚ç‚¹ä¿¡æ¯
    > "${client_url_file}"

    # æ ¹æ® IP æƒ…å†µç”ŸæˆèŠ‚ç‚¹
    local has_ipv4=0
    local has_ipv6=0

    # è·å–å½“å‰é…ç½®çš„SNIå’ŒPublic Key
    local current_sni=$(jq -r '.inbounds[] | select(.type == "vless") | .tls.server_name' "${config_file}")
    local current_pbk=$(jq -r '.inbounds[] | select(.type == "vless") | .tls.reality.private_key' "${config_file}" | /etc/sing-box/sing-box reality keypair --private-key-file /dev/stdin | awk '/PublicKey:/ {print $2}')
    local current_uuid=$(jq -r '.inbounds[] | select(.type == "vless") | .users[0].uuid' "${config_file}")
    local current_port=$(jq -r '.inbounds[] | select(.type == "vless") | .listen_port' "${config_file}")

    if [ -n "$ipv4" ]; then
        has_ipv4=1
        cat >> "${client_url_file}" <<EOF
vless://${current_uuid}@${ipv4}:${current_port}?encryption=none&flow=xtls-rprx-vision&security=reality&sni=${current_sni}&fp=chrome&pbk=${current_pbk}&type=tcp&headerType=none#${isp}_IPv4
EOF
    fi

    if [ -n "$ipv6" ]; then
        has_ipv6=1
        cat >> "${client_url_file}" <<EOF
vless://${current_uuid}@[${ipv6}]:${current_port}?encryption=none&flow=xtls-rprx-vision&security=reality&sni=${current_sni}&fp=chrome&pbk=${current_pbk}&type=tcp&headerType=none#${isp}_IPv6
EOF
    fi

    echo ""

    # æ˜¾ç¤ºç½‘ç»œçŠ¶æ€è¯´æ˜
    if [ $has_ipv4 -eq 1 ] && [ $has_ipv6 -eq 1 ]; then
        green "âœ“ æ£€æµ‹åˆ°åŒæ ˆç½‘ç»œ (IPv4 + IPv6)\n"
    elif [ $has_ipv4 -eq 1 ]; then
        yellow "âš ï¸ ä»…æ£€æµ‹åˆ° IPv4 ç½‘ç»œ (æ— å¯ç”¨ IPv6)\n"
    elif [ $has_ipv6 -eq 1 ]; then
        yellow "âš ï¸ ä»…æ£€æµ‹åˆ° IPv6 ç½‘ç»œ (æ— å¯ç”¨ IPv4)\n"
    else
        red "âŒ æœªæ£€æµ‹åˆ°å¯ç”¨çš„å…¬ç½‘ IP åœ°å€\n"
        return 1
    fi

    # æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
    green "ğŸ”— æ‚¨çš„ vless-reality èŠ‚ç‚¹é“¾æ¥:\n"
    while IFS= read -r line; do
        echo -e "${purple}$line"
    done < "${client_url_file}"

    # ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”ŸæˆäºŒç»´ç 
    if [ $has_ipv4 -eq 1 ] && command_exists "${work_dir}/qrencode"; then
        yellow "\nğŸ“¸ [IPv4 èŠ‚ç‚¹äºŒç»´ç ]"
        grep "_IPv4" "${client_url_file}" | "${work_dir}/qrencode" -o -m 2 -s 6 -t ANSIUTF8 # ä¼˜åŒ– qrencode å‚æ•°
    fi

    if [ $has_ipv6 -eq 1 ] && command_exists "${work_dir}/qrencode"; then
        yellow "\nğŸ“¸ [IPv6 èŠ‚ç‚¹äºŒç»´ç ]"
        grep "_IPv6" "${client_url_file}" | "${work_dir}/qrencode" -o -m 2 -s 6 -t ANSIUTF8 # ä¼˜åŒ– qrencode å‚æ•°
    fi

    yellow "\nğŸ’¡ æ¸©é¦¨æé†’ï¼šè¯·åœ¨å®¢æˆ·ç«¯æ‰“å¼€ 'è·³è¿‡è¯ä¹¦éªŒè¯' (Insecure æˆ– TLS è®¾ç½®ä¸º true)ã€‚\n"
}

# é€šç”¨æœåŠ¡ç®¡ç†å‡½æ•°
manage_service() {
    local service_name="$1"
    local action="$2"

    if [ -z "$service_name" ] || [ -z "$action" ]; then
        red "âŒ ç¼ºå°‘æœåŠ¡åæˆ–æ“ä½œå‚æ•°\n"
        return 1
    fi

    local status_output=$(check_service "$service_name" "${work_dir}/${server_name}")
    local status_code=$? # 0: ok, 1: error, 2: not installed

    case "$action" in
        "start")
            if [ "$status_output" == "$(green "running")" ]; then
                yellow "â„¹ï¸ ${service_name} æ­£åœ¨è¿è¡Œ\n"
                return 0
            elif [ "$status_code" -eq 2 ]; then # Not installed
                yellow "â„¹ï¸ ${service_name} å°šæœªå®‰è£…!\n"
                return 1
            else
                yellow "âš™ï¸ æ­£åœ¨å¯åŠ¨ ${service_name} æœåŠ¡\n"
                if command_exists rc-service; then
                    rc-service "$service_name" start
                elif command_exists systemctl; then
                    systemctl daemon-reload # é‡è½½é…ç½®ç¡®ä¿æœ€æ–°
                    systemctl start "$service_name"
                else
                    red "âŒ æœªçŸ¥ init ç³»ç»Ÿï¼Œæ— æ³•å¯åŠ¨æœåŠ¡ã€‚"
                    return 1
                fi

                if [ $? -eq 0 ]; then
                    green "âœ… ${service_name} æœåŠ¡å·²æˆåŠŸå¯åŠ¨\n"
                    return 0
                else
                    red "âŒ ${service_name} æœåŠ¡å¯åŠ¨å¤±è´¥\n"
                    return 1
                fi
            fi
            ;;

        "stop")
            if [ "$status_code" -eq 2 ]; then
                yellow "â„¹ï¸ ${service_name} å°šæœªå®‰è£…ï¼\n"
                return 2
            elif [ "$status_output" == "$(yellow "not running")" ]; then
                yellow "â„¹ï¸ ${service_name} æœªè¿è¡Œ\n"
                return 1
            else
                yellow "âš™ï¸ æ­£åœ¨åœæ­¢ ${service_name} æœåŠ¡\n"
                if command_exists rc-service; then
                    rc-service "$service_name" stop
                elif command_exists systemctl; then
                    systemctl stop "$service_name"
                else
                    red "âŒ æœªçŸ¥ init ç³»ç»Ÿï¼Œæ— æ³•åœæ­¢æœåŠ¡ã€‚"
                    return 1
                fi

                if [ $? -eq 0 ]; then
                    green "âœ… ${service_name} æœåŠ¡å·²æˆåŠŸåœæ­¢\n"
                    return 0
                else
                    red "âŒ ${service_name} æœåŠ¡åœæ­¢å¤±è´¥\n"
                    return 1
                fi
            fi
            ;;

        "restart")
            if [ "$status_code" -eq 2 ]; then
                yellow "â„¹ï¸ ${service_name} å°šæœªå®‰è£…ï¼\n"
                return 1
            else
                yellow "âš™ï¸ æ­£åœ¨é‡å¯ ${service_name} æœåŠ¡\n"
                if command_exists rc-service; then
                    rc-service "$service_name" restart
                elif command_exists systemctl; then
                    systemctl daemon-reload # é‡è½½é…ç½®ç¡®ä¿æœ€æ–°
                    systemctl restart "$service_name"
                else
                    red "âŒ æœªçŸ¥ init ç³»ç»Ÿï¼Œæ— æ³•é‡å¯æœåŠ¡ã€‚"
                    return 1
                fi

                if [ $? -eq 0 ]; then
                    green "âœ… ${service_name} æœåŠ¡å·²æˆåŠŸé‡å¯\n"
                    return 0
                else
                    red "âŒ ${service_name} æœåŠ¡é‡å¯å¤±è´¥\n"
                    return 1
                fi
            fi
            ;;

        *)
            red "âŒ æ— æ•ˆçš„æ“ä½œ: $action\n"
            red "å¯ç”¨æ“ä½œ: start, stop, restart\n"
            return 1
            ;;
    esac
}

# å¯åŠ¨ sing-box
start_singbox() {
    manage_service "sing-box" "start"
}

# åœæ­¢ sing-box
stop_singbox() {
    manage_service "sing-box" "stop"
}

# é‡å¯ sing-box
restart_singbox() {
    manage_service "sing-box" "restart"
}

# å¸è½½ sing-box
uninstall_singbox() {
    reading "ğŸ”´ ç¡®å®šè¦å¸è½½ sing-box å—? (y/n): " choice
    case "${choice}" in
        y|Y)
            yellow "ğŸ—‘ï¸ æ­£åœ¨å¸è½½ sing-box..."
            stop_singbox # å°è¯•åœæ­¢æœåŠ¡
            if command_exists rc-service; then
                rm -f /etc/init.d/sing-box
                rc-update del sing-box default >/dev/null 2>&1
            elif command_exists systemctl; then
                systemctl disable "${server_name}" >/dev/null 2>&1
                rm -f "/etc/systemd/system/${server_name}.service"
                systemctl daemon-reload || true
            else
                yellow "âš ï¸ æœªçŸ¥ init ç³»ç»Ÿï¼Œè¯·æ‰‹åŠ¨æ¸…ç†æœåŠ¡æ–‡ä»¶ã€‚"
            fi
            rm -rf "${work_dir}" || true
            # æ¸…ç†é˜²ç«å¢™è§„åˆ™ (ä»…æ¸…ç†ç«¯å£ï¼Œä¸å½±å“åŸºç¡€è§„åˆ™)
            local current_port=$(jq -r '.inbounds[] | select(.type == "vless") | .listen_port' "${config_file}" 2>/dev/null)
            if [ -n "$current_port" ]; then
                red "âš™ï¸ å°è¯•ç§»é™¤é˜²ç«å¢™è§„åˆ™ for port ${current_port}/tcp..."
                command_exists ufw && ufw delete allow "${current_port}/tcp" >/dev/null 2>&1
                command_exists firewall-cmd && firewall-cmd --permanent --remove-port="${current_port}/tcp" >/dev/null 2>&1 && firewall-cmd --reload >/dev/null 2>&1
                if command_exists iptables; then
                    iptables -D INPUT -p tcp --dport "${current_port}" -j ACCEPT 2>/dev/null
                    ip6tables -D INPUT -p tcp --dport "${current_port}" -j ACCEPT 2>/dev/null
                    # æŒä¹…åŒ–æ›´æ”¹
                    if command_exists netfilter-persistent; then
                        netfilter-persistent save >/dev/null 2>&1
                    elif command_exists service; then
                        service iptables save 2>/dev/null
                        service ip6tables save 2>/dev/null
                    fi
                fi
            fi
            green "\nâœ… sing-box å¸è½½æˆåŠŸ\n\n" && exit 0
            ;;
        *)
            purple "â„¹ï¸ å·²å–æ¶ˆå¸è½½æ“ä½œ\n\n"
            ;;
    esac
}

# åˆ›å»ºå¿«æ·æŒ‡ä»¤
create_shortcut() {
    yellow "ğŸ”— æ­£åœ¨åˆ›å»ºå¿«æ·æŒ‡ä»¤ 'sb'..."
    cat > "$work_dir/sb.sh" << 'EOF'
#!/usr/bin/env bash
# æ­¤å¤„URLè¯·æ›¿æ¢ä¸ºæ‚¨å®é™…çš„GitHubä»“åº“åœ°å€
bash <(curl -Ls https://raw.githubusercontent.com/yourusername/vless-reality/main/vless-reality.sh) "$@"
EOF
    chmod +x "$work_dir/sb.sh"
    # Ensure /usr/bin is in PATH for all users
    ln -sf "$work_dir/sb.sh" /usr/bin/sb
    if [ -s /usr/bin/sb ]; then
        green "\nâœ… å¿«æ·æŒ‡ä»¤ ${skyblue}sb${re} åˆ›å»ºæˆåŠŸï¼ç°åœ¨å¯ä»¥é€šè¿‡è¾“å…¥ ${skyblue}sb${re} å‘¼å‡ºè„šæœ¬èœå•ã€‚\n"
    else
        red "\nâŒ å¿«æ·æŒ‡ä»¤åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥/usr/binç›®å½•æƒé™ã€‚\n"
    fi
}

# é€‚é…alpineè¿è¡Œçš„é—®é¢˜
change_hosts() {
    # å…è®¸érootç”¨æˆ·ping
    sh -c 'echo "0 0" > /proc/sys/net/ipv4/ping_group_range' 2>/dev/null || yellow "âš ï¸ æ— æ³•è®¾ç½® ping_group_rangeï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´ã€‚"
    # ç¡®ä¿ /etc/hosts æ–‡ä»¶æ ¼å¼æ­£ç¡®
    if ! grep -q '^127\.0\.0\.1\s\+localhost' /etc/hosts || ! grep -q '^::1\s\+localhost' /etc/hosts; then
        sed -i '1s/.*/127.0.0.1   localhost/' /etc/hosts
        sed -i '2s/.*/::1         localhost/' /etc/hosts
        green "âœ“ /etc/hosts æ–‡ä»¶å·²ä¼˜åŒ–ã€‚"
    fi
}

# å˜æ›´é…ç½®
change_config() {
    local singbox_status=$(check_singbox)
    local singbox_installed=$?

    if [ $singbox_installed -eq 2 ]; then # Not installed
        yellow "âš ï¸ sing-box å°šæœªå®‰è£…ï¼Œæ— æ³•ä¿®æ”¹é…ç½®ï¼"
        sleep 2
        return
    elif [ $singbox_installed -eq 1 ]; then # Error checking status
        yellow "âš ï¸ æ— æ³•è·å– sing-box çŠ¶æ€ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ–‡ä»¶ï¼"
        sleep 2
        return
    fi
    clear
    echo ""
    green "=== ä¿®æ”¹èŠ‚ç‚¹é…ç½® ===\n"
    purple "sing-boxå½“å‰çŠ¶æ€: ${singbox_status}\n"
    green "1. ä¿®æ”¹ç«¯å£"
    skyblue "------------"
    green "2. ä¿®æ”¹UUID"
    skyblue "------------"
    green "3. ä¿®æ”¹Realityä¼ªè£…åŸŸå (SNI)"
    skyblue "------------"
    red "0. è¿”å›ä¸»èœå•"
    skyblue "------------"
    reading "è¯·è¾“å…¥é€‰æ‹©: " choice_config
    case "${choice_config}" in
        1)
            reading "\nè¯·è¾“å…¥æ–°çš„ vless-reality ç«¯å£ (å›è½¦è·³è¿‡å°†ä½¿ç”¨éšæœºç«¯å£): " new_port
            local old_port=$(jq -r '.inbounds[] | select(.type == "vless") | .listen_port' "${config_file}")
            [ -z "$new_port" ] && new_port=$(shuf -i 10000-65000 -n 1) # å†æ¬¡ç”Ÿæˆéšæœºç«¯å£
          
            # ä½¿ç”¨ jq ä¿®æ”¹ JSON é…ç½®
            if jq --argjson np "$new_port" '(.inbounds[] | select(.type == "vless") | .listen_port) = $np' "$config_file" > "${config_file}.tmp" && mv "${config_file}.tmp" "$config_file"; then
                yellow "âš™ï¸ æ­£åœ¨ç§»é™¤æ—§ç«¯å£ ${old_port}/tcp çš„é˜²ç«å¢™è§„åˆ™..."
                local has_ufw=$(command_exists ufw && echo 1 || echo 0)
                local has_firewalld=$(command_exists firewall-cmd && systemctl is-active --quiet firewalld && echo 1 || echo 0)
                local has_iptables=$(command_exists iptables && echo 1 || echo 0)
                local has_ip6tables=$(command_exists ip6tables && echo 1 || echo 0)

                [ "$has_ufw" -eq 1 ] && ufw delete allow "${old_port}/tcp" >/dev/null 2>&1
                [ "$has_firewalld" -eq 1 ] && firewall-cmd --permanent --remove-port="${old_port}/tcp" >/dev/null 2>&1
                [ "$has_iptables" -eq 1 ] && iptables -D INPUT -p tcp --dport "${old_port}" -j ACCEPT 2>/dev/null
                [ "$has_ip6tables" -eq 1 ] && ip6tables -D INPUT -p tcp --dport "${old_port}" -j ACCEPT 2>/dev/null
                [ "$has_firewalld" -eq 1 ] && firewall-cmd --reload >/dev/null 2>&1

                green "âœ… æ—§ç«¯å£ ${purple}${old_port}${re} çš„é˜²ç«å¢™è§„åˆ™å·²ç§»é™¤ã€‚"
                allow_port "$new_port/tcp" # æ·»åŠ æ–°ç«¯å£è§„åˆ™å¹¶æŒä¹…åŒ–
                restart_singbox
                green "\nâœ… vless-reality ç«¯å£å·²ä¿®æ”¹æˆï¼š${purple}$new_port${re}\n"
                get_info # é‡æ–°ç”Ÿæˆå¹¶æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
            else
                red "âŒ ä¿®æ”¹ç«¯å£å¤±è´¥ï¼"
            fi
            ;;
        2)
            reading "\nè¯·è¾“å…¥æ–°çš„UUID (å›è½¦ç”ŸæˆéšæœºUUID): " new_uuid
            [ -z "$new_uuid" ] && new_uuid=$(cat /proc/sys/kernel/random/uuid)
          
            if jq --arg nw "$new_uuid" '(.inbounds[] | select(.type == "vless") | .users[0].uuid) = $nw' "$config_file" > "${config_file}.tmp" && mv "${config_file}.tmp" "$config_file"; then
                restart_singbox
                green "\nâœ… UUIDå·²ä¿®æ”¹ä¸ºï¼š${purple}${new_uuid}${re}\n"
                get_info # é‡æ–°ç”Ÿæˆå¹¶æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
            else
                red "âŒ ä¿®æ”¹UUIDå¤±è´¥ï¼"
            fi
            ;;
        3)
            clear
            green "\nè¯·é€‰æ‹©æˆ–è¾“å…¥æ–°çš„ Reality ä¼ªè£…åŸŸå (SNI):"
            green "1. www.apple.com (é»˜è®¤)"
            green "2. www.joom.com"
            green "3. www.stengg.com"
            green "4. www.wedgehr.com"
            green "5. www.cerebrium.ai"
            green "6. www.nazhumi.com"
            reading "\nè¯·è¾“å…¥é€‰æ‹© (1-6) æˆ–è‡ªå®šä¹‰åŸŸå: " sni_choice
            local new_sni=""
            case "$sni_choice" in
                1|"") new_sni="www.apple.com" ;;
                2) new_sni="www.joom.com" ;;
                3) new_sni="www.stengg.com" ;;
                4) new_sni="www.wedgehr.com" ;;
                5) new_sni="www.cerebrium.ai" ;;
                6) new_sni="www.nazhumi.com" ;;
                *) new_sni="$sni_choice" ;; # è‡ªå®šä¹‰è¾“å…¥
            esac
          
            if jq --arg new_sni "$new_sni" '
            (.inbounds[] | select(.type == "vless") | .tls.server_name) = $new_sni |
            (.inbounds[] | select(.type == "vless") | .tls.reality.handshake.server) = $new_sni
            ' "$config_file" > "${config_file}.tmp" && mv "${config_file}.tmp" "$config_file"; then
                restart_singbox
                green "\nâœ… Reality SNI å·²ä¿®æ”¹ä¸ºï¼š${purple}${new_sni}${re}\n"
                get_info # é‡æ–°ç”Ÿæˆå¹¶æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
            else
                red "âŒ ä¿®æ”¹SNIå¤±è´¥ï¼"
            fi
            ;;
        0) menu ;;
        *) red "âŒ æ— æ•ˆçš„é€‰é¡¹ï¼" ;;
    esac
}

# singbox ç®¡ç†
manage_singbox() {
    local singbox_status=$(check_singbox)
    local singbox_installed=$?

    clear
    echo ""
    green "=== sing-box ç®¡ç† ===\n"
    purple "sing-boxå½“å‰çŠ¶æ€: ${singbox_status}\n"
    green "1. å¯åŠ¨ sing-box æœåŠ¡"
    skyblue "-------------------"
    green "2. åœæ­¢ sing-box æœåŠ¡"
    skyblue "-------------------"
    green "3. é‡å¯ sing-box æœåŠ¡"
    skyblue "-------------------"
    red "0. è¿”å›ä¸»èœå•"
    skyblue "------------"
    reading "\nè¯·è¾“å…¥é€‰æ‹©: " choice_manage
    case "${choice_manage}" in
        1) start_singbox ;;
        2) stop_singbox ;;
        3) restart_singbox ;;
        0) menu ;;
        *) red "âŒ æ— æ•ˆçš„é€‰é¡¹ï¼" && sleep 1 && manage_singbox;;
    esac
}

# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
check_nodes() {
    # æ£€æŸ¥ sing-box æ˜¯å¦å®‰è£…
    check_singbox &>/dev/null; local singbox_status_code=$?

    if [ ${singbox_status_code} -eq 2 ]; then # Not installed
        red "âŒ sing-box å°šæœªå®‰è£…ï¼Œæ— æ³•æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼"
        sleep 2
        return
    fi
     if [ ! -f "${config_file}" ]; then
        red "âŒ sing-box é…ç½®ç›®å½•æˆ–æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·å…ˆå®‰è£… sing-boxï¼"
        sleep 2
        return
    fi

    # é‡æ–°æ£€æµ‹ IP ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    yellow "\nğŸŒ IPæ£€æµ‹ä¸­,è¯·ç¨ç­‰...\n"
    local ip_result=$(get_realip)
    local ipv4=$(echo "$ip_result" | cut -d'|' -f1)
    local ipv6=$(echo "$ip_result" | cut -d'|' -f2)

    clear
    echo ""

    # æ˜¾ç¤ºç½‘ç»œçŠ¶æ€
    if [ -n "$ipv4" ] && [ -n "$ipv6" ]; then
        green "âœ“ å½“å‰ç½‘ç»œçŠ¶æ€: åŒæ ˆ (IPv4 + IPv6)\n"
    elif [ -n "$ipv4" ]; then
        yellow "âš ï¸ å½“å‰ç½‘ç»œçŠ¶æ€: ä»… IPv4\n"
    elif [ -n "$ipv6" ]; then
        yellow "âš ï¸ å½“å‰ç½‘ç»œçŠ¶æ€: ä»… IPv6\n"
    else
        red "âŒ å½“å‰ç½‘ç»œçŠ¶æ€: æ— å¯ç”¨å…¬ç½‘ IP\n"
    fi

    # å°è¯•è¯»å–é…ç½®ç”Ÿæˆæœ€æ–°çš„é“¾æ¥
    if [ -f "${config_file}" ] && [ -f "${work_dir}/qrencode" ]; then
        get_info # è°ƒç”¨ get_info æ¥ç”Ÿæˆå¹¶æ˜¾ç¤ºæœ€æ–°çš„èŠ‚ç‚¹ä¿¡æ¯åŠäºŒç»´ç 
    else
        red "âŒ æœªæ‰¾åˆ° sing-box é…ç½®æ–‡ä»¶æˆ– qrencode å·¥å…·ï¼Œè¯·ç¡®è®¤ sing-box å·²æ­£ç¡®å®‰è£…ã€‚"
    fi
}


# ä¸»èœå•
menu() {
    local singbox_status_text=$(check_singbox) # è·å–å¸¦é¢œè‰²è¾“å‡ºçš„çŠ¶æ€æ–‡æœ¬
    local singbox_status_code=$? # è·å– check_singbox çš„è¿”å›å€¼

    clear
    echo ""
    purple "=== vless-reality ä¸€é”®å®‰è£…è„šæœ¬ ===\n"
    if [ "$singbox_status_code" -eq 0 ]; then
        purple "sing-box çŠ¶æ€: ${singbox_status_text}\n"
    else
        red "sing-box çŠ¶æ€: ${singbox_status_text}\n"
    fi
    green "1. å®‰è£… sing-box"
    red "2. å¸è½½ sing-box"
    echo "================"
    green "3. sing-box ç®¡ç†"
    echo "================"
    green "4. æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯"
    green "5. ä¿®æ”¹èŠ‚ç‚¹é…ç½®"
    echo "================"
    red "0. é€€å‡ºè„šæœ¬"
    echo "==========="
    reading "è¯·è¾“å…¥é€‰æ‹©(0-5): " choice
    echo ""
}

# æ•è· Ctrl+C é€€å‡ºä¿¡å·
trap 'red "\n\nğŸ‘‹ å·²å–æ¶ˆæ“ä½œï¼Œé€€å‡ºè„šæœ¬ã€‚"; exit 1' INT

# ä¸»å¾ªç¯
while true; do
    menu
    case "${choice}" in
        1)
            check_singbox &>/dev/null; local check_singbox_installed=$? # 0: running, 1: not running, 2: not installed
            if [ ${check_singbox_installed} -eq 0 ] || [ ${check_singbox_installed} -eq 1 ]; then
                yellow "âš ï¸ sing-box ä¼¼ä¹å·²ç»å®‰è£… (${check_singbox_installed})ï¼å¦‚æœéœ€è¦ï¼Œè¯·å…ˆå¸è½½ã€‚"
            else
                install_singbox
                if command_exists systemctl; then
                    main_systemd_services
                elif command_exists rc-update; then # Alpine
                    alpine_openrc_services
                    change_hosts # é’ˆå¯¹ Alpine çš„ä¸»æœºé…ç½®è°ƒæ•´
                else
                    red "âŒ ä¸æ”¯æŒçš„ init ç³»ç»Ÿ! æ— æ³•è®¾ç½®æœåŠ¡å¼€æœºè‡ªå¯ã€‚"
                    exit 1
                fi
                sleep 2 # ç¨å¾®ç­‰å¾…æœåŠ¡å¯åŠ¨
                get_info
                create_shortcut
            fi
            ;;
        2) uninstall_singbox ;;
        3) manage_singbox ;;
        4) check_nodes ;;
        5) change_config ;;
        0) green "ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼ \n" && exit 0 ;;
        *) red "âŒ æ— æ•ˆçš„é€‰é¡¹ï¼Œè¯·è¾“å…¥ 0 åˆ° 5" ;;
    esac
    yellow "\næŒ‰ä»»æ„é”®è¿”å›ä¸»èœå•..."
    read -n 1 -s -r
done
```
